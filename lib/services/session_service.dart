import '../models/pomodoro_session.dart';
import 'auth_service.dart';
import 'database_service.dart';
import 'sync_service.dart';
import 'api_service.dart';

/// High-level helpers to record and read Pomodoro sessions.
class SessionService {
  SessionService._();
  static final SessionService instance = SessionService._();

  /// Record a completed Pomodoro session locally.
  /// Automatically attempts to sync if a user is logged in and online.
  Future<PomodoroSession> recordCompletedSession(int durationMinutes) async {
    final user = AuthService.instance.currentUser;
    final nowMs = DateTime.now().millisecondsSinceEpoch;
    final session = PomodoroSession(
      id: '', // UUID will be generated by DatabaseService
      userId: user?.id,
      duration: durationMinutes,
      completedAt: nowMs,
      synced: false,
    );
    final saved = await DatabaseService.instance.insertSession(session);

    // Trigger a sync attempt
    await SyncService.instance.syncUnsyncedSessionsForCurrentUser();
    return saved;
  }

  /// List all sessions for the current user. If not logged in, returns all local sessions.
  Future<List<PomodoroSession>> listSessionsForCurrentUser() async {
    final user = AuthService.instance.currentUser;
    return DatabaseService.instance.getSessions(userId: user?.id);
  }

  /// Merge local and remote sessions for the current user.
  /// - Local includes unsynced and synced entries
  /// - Remote includes server synced entries
  /// De-duplicates by `(duration, completedAt)` signature to avoid showing
  /// duplicates when local UUIDs differ from remote BIGSERIAL ids.
  Future<List<PomodoroSession>> mergedSessionsForCurrentUser() async {
    final user = AuthService.instance.currentUser;
    final local = await DatabaseService.instance.getSessions(userId: user?.id);
    if (user == null) return local;
    List<PomodoroSession> remote = [];
    try {
      remote = await ApiService.instance.fetchSessionsForUser(user.id);
    } catch (_) {
      // If remote fetch fails (offline, server), still show local sessions.
      remote = [];
    }
    final bySignature = <String, PomodoroSession>{};
    for (final s in local) {
      final sig = '${s.duration}|${s.completedAt}';
      bySignature[sig] = s;
    }
    for (final s in remote) {
      final sig = '${s.duration}|${s.completedAt}';
      final existing = bySignature[sig];
      if (existing == null) {
        bySignature[sig] = s;
      } else {
        // Prefer remote for already-synced entries; keep local if it's unsynced
        if (existing.synced) {
          bySignature[sig] = s;
        }
      }
    }
    final all = bySignature.values.toList();
    all.sort((a, b) => b.completedAt.compareTo(a.completedAt));
    return all;
  }
}